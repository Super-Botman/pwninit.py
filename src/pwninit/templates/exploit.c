#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/prctl.h>

#define info(fmt, ...)  fprintf(stdout, "[*] " fmt "\n", ##__VA_ARGS__)
#define ok(fmt, ...)    fprintf(stdout, "[+] " fmt "\n", ##__VA_ARGS__)
#define fail(fmt, ...)  do { fprintf(stderr, "[-] " fmt "\n", ##__VA_ARGS__); exit(1); } while(0)

static void check_root(void) {
    if (getuid() == 0) {
        ok("root! uid=0");
        system("/bin/sh");
        exit(0);
    }
    fail("still uid=%d â€” exploit failed", getuid());
}

static void __attribute__((noreturn)) escalate(void) {
    info("attempting privilege escalation ...");

    // TODO: implem exploit
    
    check_root();
    __builtin_unreachable();
}

int main(int argc, char **argv) {
    (void)argc; (void)argv;

    info("pid = %d, uid = %d", getpid(), getuid());

    int fd = open("/dev/${kernel_module}", O_RDWR);
    if (fd < 0)
        fail("open /dev/${kernel_module}: %s", strerror(errno));
    ok("opened device fd=%d", fd);

    escalate();
}
